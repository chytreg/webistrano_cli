#!/usr/bin/env ruby
require 'rubygems'
require 'slop'

require File.join(File.dirname(__FILE__), '../lib/webistrano_cli/config')
require File.join(File.dirname(__FILE__), '../lib/webistrano_cli/her_api_init')
config = WebistranoCli::Config.new
config.setup_and_load!

WebistranoCli::API = Her::API.new
WebistranoCli::API.setup :url => config.get_value('url') do |c|
  c.headers['Accept']       = 'application/xml'
  c.headers['Content-Type'] = 'application/xml'
  c.basic_auth config.get_value('user'), config.get_value('password')
  c.response :logger if ENV['WCLI_DEBUG']
  c.use HerXmlParser
  c.use HerXMLPost
  c.adapter Faraday.default_adapter
end

# load api related models
require File.join(File.dirname(__FILE__), '../lib/webistrano_cli')

# parse assumes ARGV, otherwise you can pass it your own Array
opts = Slop.new :help => true do
  banner 'Usage: webistrano_cli -p project_name'
  description 'command allow to deploy projects from webistrano'
  on :p, :project=, 'Project name', :as => String
  on :s, :stage=,   'Stage',        :as => String
  on :t, :task=,    'Task',         :as => String
  on :v, :version, 'Print the version' do
    puts "Version #{WebistranoCli::VERSION}"
  end
end

begin
  opts.parse
  hash = opts.to_hash
  unless opts.p?
    hash[:project] = File.split(Dir.pwd).last
    puts "No project param, used current dir name."
  end
  WebistranoCli.deploy(hash, config)
rescue Slop::Error => ex
  puts ex.message
end
